name: Update No Commits Counter

on:
  schedule:
    - cron: '0 0 * * *'  # Запуск каждый день в полночь
  workflow_dispatch:      # Позволяет запускать вручную
  # Убрали push, чтобы избежать лишних запусков

jobs:
  update-counter:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      
      - name: Check last commit date
        id: last_commit
        run: |
          LAST_COMMIT=$(git log -1 --format=%ct)
          CURRENT_TIME=$(date +%s)
          DAYS_DIFF=$(( ($CURRENT_TIME - $LAST_COMMIT) / 86400 ))
          echo "DAYS_WITHOUT_COMMITS=$DAYS_DIFF" >> $GITHUB_ENV
          # Добавляем отладку
          echo "Last commit timestamp: $LAST_COMMIT"
          echo "Current timestamp: $CURRENT_TIME"
          echo "Days without commits: $DAYS_DIFF"
          
      - name: Update README
        run: |
          # Более надежный паттерн для sed
          sed -i "s/\(Days_without_commits-\)[0-9]*\(-green\)/\1${{ env.DAYS_WITHOUT_COMMITS }}\2/" README.md
          # Показываем, что получилось
          echo "Updated README.md:"
          cat README.md
          
      - name: Commit changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add README.md
          # Проверяем, есть ли изменения, и только тогда коммитим
          if ! git diff --staged --quiet; then
            git commit -m "Update days without commits counter to ${{ env.DAYS_WITHOUT_COMMITS }}"
            git push
          else
            echo "No changes to commit"
          fi
